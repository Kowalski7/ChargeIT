function loadMap() {
    const map = new L.Map('map');
    const myIcon = L.icon({
        iconUrl: '/assets/images/pin-icon.png',
        iconRetinaUrl: '/assets/images/pin-icon-2x.png',
        iconSize: [25, 36],
        iconAnchor: [12, 36],
        popupAnchor: [0, -35],
        shadowUrl: '/assets/images/marker-shadow.png',
        shadowSize: [36, 36],
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
        maxZoom: 18
    }).addTo(map);
    //map.attributionControl.setPrefix(''); // Don't show the 'Powered by Leaflet' text.

    const romania = new L.LatLng(45.996,24.981);
    map.setView(romania, 7);

    // Define an array. This could be done in a separate js file.
    // This tidy formatted section could even be generated by a server-side script
    // or fetched separately as a jsonp request.
    $.get("/api/stations", function(markers, status) {
        //Loop through the markers array
        for (let i=0; i<markers.length; i++) {
            const lon = markers[i].lon;
            const lat = markers[i].lat;
            const popupText = '<div class="text-center"><b>' + markers[i].name + '</b><br><input class="btn btn-primary btn-sm mt-3 w-75" type="button" onclick="viewStation(\'' + markers[i].uuid + '\')" value="View details" /></div>';

            const markerLocation = new L.LatLng(lat, lon);
            const marker = new L.Marker(markerLocation, {icon: myIcon});
            map.addLayer(marker);

            marker.bindPopup(popupText);
        }
    }).fail(function() {
        alert("An error has occurred and we were unable to place the stations on the map!\n\nRefreshing the page should fix this problem. If it doesn't, please report the issue to the site administrators.")
    })
}

function loadModal(url) {
    document.getElementById("modalEmbed").src = url;
}

function viewStation(stationId) {
    const tbody = document.getElementById("plugsTableBody");

    // reset station viewer
    document.getElementById("stationName").innerText = "Loading...";
    document.getElementById("stationLocation").innerText = "Loading...";
    document.getElementById("stationGMaps").href = "#";
    tbody.innerHTML = '<h6 class="text-muted">Loading...</h6>';

    // fetch station data
    $.get("/api/station/" + stationId, function(data, status) {
        document.getElementById("stationName").innerText = data.name;
        document.getElementById("stationLocation").innerText = data.address;
        document.getElementById("stationGMaps").href = "https://www.google.com/maps/search/" + encodeURIComponent(data.address);
    }).fail(function() {
        document.getElementById("stationName").innerText = "Error";
        document.getElementById("stationLocation").innerText = "Station not found!";
        tbody.innerText = "";
    })

    // fetch station plugs
    $.get("/api/plugs?station=" + stationId, function(data, status) {
        tbody.innerHTML = "";
        data.forEach(function(jsonObj) {
            let row = document.createElement("tr");
            let cell_status = document.createElement("td");
            let cell_connector = document.createElement("td");
            let cell_output = document.createElement("td");
            let cell_options = document.createElement("td");
            cell_status.innerHTML = '<i class="bi bi-circle-fill" style="color: ' + (jsonObj.status ? 'green' : 'red') + ';"></i>';
            cell_connector.innerText = jsonObj.connector;
            cell_output.innerText = jsonObj.output;
            cell_options.innerHTML = jsonObj.status ? '<input type=button class="btn btn-outline-success" value="Book" data-toggle="modal" data-target="#bookingModal" onclick="loadModal(\'/booking?plug=' + jsonObj.id + '\')" />' : '';
            row.appendChild(cell_status);
            row.appendChild(cell_connector);
            row.appendChild(cell_output);
            row.appendChild(cell_options);
            tbody.appendChild(row);
        });
    }).fail(function() {
        tbody.innerText = "";
    });

    // document.getElementById("sb").style.display = "";
    $('#sb').show('slide', {direction: 'left'}, 250);
}

function closeViewer() {
    // document.getElementById("sb").style.display = "none";
    $('#sb').hide('slide', {direction: 'left'}, 250);
}