{% extends 'base.html.twig' %}

{% block title %}ChargeIT Homepage{% endblock %}

{% block navigable %}
    <script>
        function newPopup(url, title) {
            window.open(url, title, 'scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=450,height=360')
        }

        function loadModal(url) {
            document.getElementById("modalEmbed").src = url + '&modal=true';
        }

        function viewStation(stationId) {
            const tbody = document.getElementById("plugsTableBody");

            // reset station viewer
            document.getElementById("stationName").innerText = "Loading...";
            document.getElementById("stationLocation").innerText = "Loading...";
            document.getElementById("stationGMaps").href = "#";
            tbody.innerHTML = '<h6 class="text-muted">Loading...</h6>';

            // fetch station data
            $.get("/api/station/" + stationId, function(data, status) {
                const jsonData = $.parseJSON(data);
                document.getElementById("stationName").innerText = jsonData.name;
                document.getElementById("stationLocation").innerText = jsonData.address;
                document.getElementById("stationGMaps").href = "https://www.google.com/maps/search/" + encodeURIComponent(jsonData.address);
            }).fail(function() {
                document.getElementById("stationName").innerText = "Error";
                document.getElementById("stationLocation").innerText = "Station not found!";
                tbody.innerText = "";
            })

            // fetch station plugs
            $.get("/api/plugs?station=" + stationId, function(data, status) {
                const jsonData = $.parseJSON(data);
                tbody.innerHTML = "";
                jsonData.forEach(function(jsonObj) {
                    let row = document.createElement("tr");
                    let cell_status = document.createElement("td");
                    let cell_connector = document.createElement("td");
                    let cell_output = document.createElement("td");
                    let cell_options = document.createElement("td");
                    cell_status.innerHTML = '<i class="bi bi-circle-fill" style="color: ' + (jsonObj.status ? 'green' : 'red') + ';"></i>';
                    cell_connector.innerText = jsonObj.connector;
                    cell_output.innerText = jsonObj.output;
                    cell_options.innerHTML = jsonObj.status ? '<input type=button class="btn btn-outline-success" value="Book" data-toggle="modal" data-target="#bookingModal" onclick="loadModal(\'/booking?plug=' + jsonObj.id + '\')" />' : '';
                    row.appendChild(cell_status);
                    row.appendChild(cell_connector);
                    row.appendChild(cell_output);
                    row.appendChild(cell_options);
                    tbody.appendChild(row);
                });
            }).fail(function() {
                tbody.innerText = "";
            });

            document.getElementById("sb").style.display = "";
        }

        function closeViewer() {
            document.getElementById("sb").style.display = "none";
        }
    </script>
    <style>
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-shrink: 100;
            flex-direction: column;
        }
        .table td, .table th {
            vertical-align: middle;
        }
        #sb {
            height: 97%;
            width: 20%;
            /*float: left;*/
            border: 5px solid transparent;
            border-radius: 10px;
            background-color: #ccc;
            margin: 0.75rem;
        }
        div.scrollWrapper{
            height: 100%;
            width: 100%;
            overflow-x: hidden;
            overflow-y: scroll;
        }
    </style>
    <div style="width: 100%; height: calc(100% - 56px); display: flex; position: relative">
        <div id="sb" class="card" style="display: none">
            <div class="card-body">
                <i onclick="closeViewer()" class="bi bi-x-lg mr-1" style="size: 1rem; color: red; float: right; font-size: 1.1em"></i>
                <h5 id="stationName" class="card-title">Station name</h5>
                <h6 id="stationLocation" class="card-subtitle mb-2 text-muted">Station address</h6>
                <a id="stationGMaps" href="#" class="card-link" target="_blank" rel="noopener">View on Google Maps</a>
                <br><br>
                <p class="card-text">Select a plug you would like to make a reservation at:</p>
                <table class="table">
                    <thead class="thead-dark">
                    <tr>
                        <th scope="col">Status</th>
                        <th scope="col">Connector</th>
                        <th scope="col">Output</th>
                        <th scope="col">Options</th>
                    </tr>
                    </thead>
                    <tbody id="plugsTableBody" >
                    </tbody>
                </table>
            </div>
        </div>
        <div style="width: 65%; margin: 1em auto; display: flex; flex-direction: column">
            <div class="mb-5" style="text-align: center">
                <h1>Charge IT Homepage</h1>
                <h3>Click on a station to view more info about it</h3>
            </div>
            <div class="scrollWrapper">
            <table class="table table-striped table-hover" style="width: 100%;">
                <colgroup>
                    <col style="width: 50%">
                    <col style="width: 35%">
                    <col style="width: 15%">
                </colgroup>
                <thead>
                <tr>
                    <th>Station</th>
                    <th>Address</th>
                    <th>Options</th>
                </tr>
                </thead>
                <tbody>
                {% for obj in jsonData %}
                    <tr>
                        <td>{{ obj.name }}</td>
                        <td>{{ obj.address }}</td>
                        <td>
                            <a class="btn btn-outline-primary" href='javascript:viewStation("{{ obj.uuid }}")'>View</a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
        <div class="modal fade" id="bookingModal" tabindex="-1" role="dialog" aria-labelledby="bookingModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="bookingModalLabel">Create booking</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <embed id="modalEmbed" style="width: 100%; height: 320px">
                    </div>
                </div>
            </div>
        </div>
    </div>
{#    <iframe style="width: 100%; height: 100%;" frameborder="0" scrolling="no" src="http://m.osmtools.de/index.php?lon=24.762634276709&lat=45.954924253876&zoom=7&iframe=1" ></iframe>#}
{#        <div style="text-align: center">#}
{#            <h1>Charge IT Homepage</h1>#}
{#            <h3>Welcome back, {{ name }}!</h3>#}
{#            <br><br>#}
{#            <span style="color: orange">UNDER CONSTRUCTION!</span><br>#}
{#            Use the navigation bar at the top of the page to go to one of the available pages.#}
{#        </div>#}
{% endblock %}
